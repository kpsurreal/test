{"version":3,"sources":["common/risk_rules.js"],"names":["RiskRules","insidePool","stock","test","stock_name","stock_code","insidePoolName","regBondETF","regCurrencyETF","regFund","freeBrokerage","getMarketType","getFeePercent","feeData","_this","marketType","freeFlag","szFlag","toLocaleLowerCase","dstFeePercent","dstFeePercentMin","fee_lower_limit","data","forEach","e","status","market","fee_type","match","Number","sz_fee_rate","fee_rate","sz_fee_lower_limit","doCheckFee","balance","price","obj","freeNumV1","Math","max","floor","freeNumV2","min","calFeeTotal","volume","balanceV1","balanceV2","initRtn","rtn","code","limitAction","ruleType","msg","num","check","rules","checkStockData","checkRulesData","doCheck","compareNums","numsPerHand","trading_unit","dstNum","frozenFreeNum","freeNum","compareReturn","IndependentBalance","hasOwnProperty","max_cash","prototype","IndependentWholePosition","getPositionInfo","tmpArr","wholePosition","push","net_value","position","limit_position","limit_action","getMaxCash","total_assets","Infinity","security","rtnArr","Object","assign","IndependentOnePosition","rulesAll","getPositionLimit","limitPosition","market_value","onePosition","stock_pool_id","customPool","el","id","list","some","cur","i","toLowerCase","stockPoolId","stockPoolName","pool_name","IndependentTarget","getStatus","blackListMsg","target","IndependentTimeArea","time_h","IndependentCanSellVolume","enable_sell_volume","IndependentPlacards","arr","checkMaxPlacardsNum","placards","stock_total_share","stock_position_num","stock_entrust_num","IndependentControTrade","checkControTradeNum","controTrade","trade_direction","stock_entrust_sell_num","stock_entrust_buy_num","UnionPlacards","placardsCo","stock_all_position_num","stock_all_entrust_num","UnionControTrade","controTradeCo","stock_all_entrust_sell_num","stock_all_entrust_buy_num","riskRules","independentBalanceCheck","independentWholePositionCheck","independentOnePositionCheck","independentTargetCheck","independentTimeAreaCheck","independentCanSellVolumeCheck","independentPlacardsCheck","independentControTradeCheck","unionPlacardsCheck","unionControTradeCheck"],"mappings":"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","file":"risk_rules.js","sourcesContent":["/**\n * 风控规则定义\n */\n// 风控规则基类\nfunction RiskRules(){\n  // 系统内部股票池\n  this.insidePool = {\n    // 全部股票\n    '-1': function(stock){\n      return true;\n    },\n    // st禁买股票 判断规则是\n    '-2': function(stock){\n      return /\\*{0,1}ST/i.test(stock.stock_name);\n    },\n    // 创业板 判断规则是 300开头的股票\n    '-3': function(stock){\n      return /^300/.test(stock.stock_code);\n    }\n  };\n\n  this.insidePoolName = {\n    '-1': function(){\n      return '全部股票';\n    },\n    '-2': function(){\n      return 'ST股票池';\n    },\n    '-3': function(){\n      return '创业板股票池';\n    }\n  };\n\n  // 根据股票代码鉴别是1、股票；2、基金（非债券ETF、非货币ETF）；3、债券ETF OR 货币ETF\n  var regBondETF = /^(511010|511210|511220)/;\n  var regCurrencyETF = /^(511600|511601)/;\n  var regFund = /^(51|50|16|18|15)\\d{4}/;\n  this.freeBrokerage = function(stock_code){\n    if (regCurrencyETF.test(stock_code) || regBondETF.test(stock_code)) {\n      return true;\n    }else{\n      return false;\n    }\n  };\n\n  this.getMarketType = function(stock_code){\n    if(regFund.test(stock_code)){\n      return 2;\n    }else{\n      return 1;\n    }\n  };\n\n  this.getFeePercent = function(stock_code, feeData){\n    var _this = this;\n    var marketType = this.getMarketType(stock_code);\n    var freeFlag = this.freeBrokerage(stock_code);\n    var szFlag = /\\.sz/.test(stock_code.toLocaleLowerCase());\n    var dstFeePercent = 0;\n    var dstFeePercentMin = 0;\n    var fee_lower_limit = 0;\n    feeData.data.forEach(function(e){\n      if (0 == e.status && e.market == marketType) {\n        if ( (e.fee_type == 1) || (freeFlag && e.fee_type == 3) ) {\n          // 印花税 买入时不收取\n          // 债券ETF OR 货币ETF不收取 经手费\n          // 股票 深交所不收取证管费和经手费 修改后，这条也是要收取的 || (1 == marketType && szFlag && e.fee_type == 3) || ( 1 == marketType && szFlag && e.fee_type == 4)\n          ;\n        }else{\n          if (e.fee_lower_limit == 0) {\n            // dstFeePercent += Number(e.fee_rate * 10000);\n            // dstFeePercentMin += Number(e.fee_rate * 10000);\n\n            if (stock_code.match(/\\.sz/ig)) {\n              dstFeePercent += Number(e.sz_fee_rate * 10000);\n              dstFeePercentMin += Number(e.sz_fee_rate * 10000);\n            }else{\n              dstFeePercent += Number(e.fee_rate * 10000);\n              dstFeePercentMin += Number(e.fee_rate * 10000);\n            }\n          }else{\n            // dstFeePercent += Number(e.fee_rate * 10000);\n            // fee_lower_limit = Number(e.fee_lower_limit);\n            if (stock_code.match(/\\.sz/ig)) {\n              dstFeePercent += Number(e.sz_fee_rate * 10000);\n              fee_lower_limit = Number(e.sz_fee_lower_limit);\n            }else{\n              dstFeePercent += Number(e.fee_rate * 10000);\n              fee_lower_limit = Number(e.fee_lower_limit);\n            }\n          }\n        }\n      }\n    });\n    return {\n      dstFeePercent: dstFeePercent / 10000,\n      dstFeePercentMin: dstFeePercentMin / 10000,\n      fee_lower_limit: fee_lower_limit\n    }\n  };\n\n  this.doCheckFee = function(stock_code, balance, price, feeData){\n    var obj = this.getFeePercent(stock_code, feeData);\n\n    var freeNumV1 = Math.max(Math.floor(balance/(price * (1 + obj.dstFeePercent / 1000)), 0));\n    var freeNumV2 = Math.max(Math.floor((balance - obj.fee_lower_limit)/(price * (1 + obj.dstFeePercentMin / 1000)), 0));\n\n    return Math.min(freeNumV1, freeNumV2);\n  }\n\n  this.calFeeTotal = function(stock_code, balance, price, feeData, volume){\n    var obj = this.getFeePercent(stock_code, feeData);\n\n    var balanceV1 = (price * (1 + obj.dstFeePercent / 1000)) * volume;\n    var balanceV2 = (price * (1 + obj.dstFeePercentMin / 1000)) * volume + obj.fee_lower_limit;\n\n    return Math.max(balanceV1, balanceV2);\n  }\n\n  // 初始化返回信息\n  this.initRtn = function(){\n    var rtn = {\n      code: 0, //错误码，0 为成功，其它失败\n      limitAction: 0,\n      ruleType: '初始化风控',\n      msg: '初始化提示信息', //提示信息\n      num: 0 //可交易数量\n    };\n    return rtn;\n  };\n\n  // 风控检查\n  // 入参1：股票相关数据（obj）\n  // 入参2: 风控规则数据（obj）\n  this.check = function(stock, rules){\n    var rtn = this.initRtn();\n    if (!this.checkStockData(stock)) {\n      rtn = {\n        code: 10001,\n        limitAction: 1, //0时预警 1时禁止\n        msg: '股票信息不全',\n        num: 0\n      }\n      return rtn;\n    }\n\n    if (!this.checkRulesData(rules)) {\n      rtn = {\n        code: 10002,\n        limitAction: 1, //0时预警 1时禁止\n        msg: '风控数据不全',\n        num: 0\n      }\n      return rtn;\n    }\n\n    rtn = this.doCheck(stock, rules);\n    return rtn;\n  };\n\n  // 数量比对，给定目标数量和可用数量，以及风控执行类型，准备返回的错误码和数量\n  // 入参：obj{dstNum:'',freeNum:'',limitAction: ''}\n  this.compareNums = function(obj){\n    var numsPerHand = obj.trading_unit ? obj.trading_unit : 100;\n    var dstNum = Number(obj.dstNum);\n    if (true == obj.frozenFreeNum) {\n      var freeNum = Number(obj.freeNum);\n    }else{\n      var freeNum = Math.floor(Number(obj.freeNum) / numsPerHand) * numsPerHand;\n    }\n\n    var rtn = this.initRtn();\n\n    rtn.dstNum = dstNum;\n    rtn.freeNum = freeNum;\n    rtn.limitAction = obj.limitAction;\n    if (obj.limitAction == 1) {\n      // 禁止的风控处理\n      if (dstNum <= freeNum) {\n        rtn.code = 0; //成功\n        rtn.num = dstNum;\n      }else{\n        rtn.code = 2; //失败\n        rtn.num = freeNum;\n      }\n    }else if(obj.limitAction == 0){\n      // 告警的风控处理\n      if (dstNum <= freeNum) {\n        rtn.code = 0; //成功\n        rtn.num = dstNum;\n      }else{\n        rtn.code = 1; //告警，但是可以买\n        rtn.num = dstNum;\n      }\n    }else{\n      rtn.limitAction = -1; //无风控条件，\n      rtn.code = 0;\n      rtn.num = dstNum;\n    }\n\n    return rtn;\n  };\n\n  // 从旧方法 compareNums 改造过来，不再按手数取整\n  this.compareReturn = function(obj){\n    var numsPerHand = obj.trading_unit ? obj.trading_unit : 100;\n    var dstNum = Number(obj.dstNum);\n    var freeNum = Number(obj.freeNum);\n    // // 继续按手数取整，这件事情应该是在这里做。因为风控提示的数字\n    // if (true == obj.frozenFreeNum) {\n    //   var freeNum = Number(obj.freeNum);\n    // }else{\n    //   var freeNum = Math.floor(Number(obj.freeNum) / numsPerHand) * numsPerHand;\n    // }\n\n    var rtn = this.initRtn();\n\n    rtn.dstNum = dstNum;\n    rtn.freeNum = freeNum;\n    rtn.limitAction = obj.limitAction;\n    if (obj.limitAction == 1) {\n      // 禁止的风控处理\n      if (dstNum <= freeNum) {\n        rtn.code = 0; //成功\n        rtn.num = dstNum;\n      }else{\n        rtn.code = 2; //失败\n        rtn.num = freeNum;\n      }\n    }else if(obj.limitAction == 0){\n      // 告警的风控处理\n      if (dstNum <= freeNum) {\n        rtn.code = 0; //成功\n        rtn.num = dstNum;\n      }else{\n        rtn.code = 1; //告警，但是可以买\n        rtn.num = dstNum;\n      }\n    }else{\n      rtn.limitAction = -1; //无风控条件，\n      rtn.code = 0;\n      rtn.num = dstNum;\n    }\n\n    return rtn;\n  }\n}\n\n// 可用资金限制。\nfunction IndependentBalance(){\n  // 校验内容：可用资金balance、价格price、数量dstNum、股票代码\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('balance') && stock.hasOwnProperty('price') && stock.hasOwnProperty('dstNum') && stock.hasOwnProperty('stock_code');\n  };\n  // 校验风控规则数据：费用信息\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('feeData');\n  };\n  this.doCheck = function(stock, rules){\n    // 修改：这里为了新增对于费用的计算，而需要新增判断。//入参：股票编码，计算总额，计算单价，费用规则\n    var freeNum = this.doCheckFee(stock.stock_code, stock.balance, stock.price, rules.feeData);\n    freeNum = Math.max(freeNum, 0);\n\n    // var freeNum = Math.max(Math.floor(stock.balance/stock.price, 0));\n    var max_cash = stock.balance;\n    var dstNum = stock.dstNum;\n\n    var rtn = this.compareReturn({\n      trading_unit: stock.trading_unit,\n      dstNum: dstNum,\n      freeNum: freeNum,\n      limitAction: 1 //禁止，因为这是可用资金的判断\n    });\n\n    if (0 == rtn.code) {\n      rtn.msg = '可用资金校验成功';\n    }else if(1 == rtn.code){\n      rtn.msg = '已触发提示性风控（个股）：可用资金不足';\n    }else{\n      rtn.msg = '已触发禁止性风控（个股）：可用资金不足';\n    }\n    rtn.ruleType = 'IndependentBalance 可用资金限制风控';\n    rtn.max_cash = max_cash;\n\n    // 3.10.0版本，doCheck不再是返回对象，而是返回数组，包含多个之前格式的对象。因为预警操作有告警和提示两种嘛。\n    return [rtn];\n  }\n}\nIndependentBalance.prototype = new RiskRules();\n\n// 整体仓位限制\nfunction IndependentWholePosition(){\n  // 校验内容：资产总值total_assets；价格price；数量dstNum；持仓市值security；当日净值net_value\n  this.checkStockData = function(stock){\n    return (stock.hasOwnProperty('total_assets') &&\n      stock.hasOwnProperty('stock_code') && \n      stock.hasOwnProperty('price') &&\n      stock.hasOwnProperty('dstNum') &&\n      stock.hasOwnProperty('security') &&\n      stock.hasOwnProperty('net_value'));\n  };\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('wholePosition') && rules.hasOwnProperty('feeData');\n  };\n  this.getPositionInfo = function(stock, rules){\n    var tmpArr = [];\n    var dstNum = stock.dstNum;\n    rules.wholePosition && rules.wholePosition.forEach(function(e){\n      // if (stock.net_value > e.net_value) { // 注意 这里是取出不符合条件的净值\n        tmpArr.push({\n          net_value: e.net_value,\n          position: e.limit_position,\n          limitAction: e.limit_action\n        });\n      // }\n    });\n\n    return tmpArr;\n  };\n\n  // 获取可用资金，仅单组合多股票页面需要，现在那块以及不做前端风控了。\n  this.getMaxCash = function(stock, rules){\n    var tmpArr = [];\n    var dstNum = stock.dstNum;\n    rules.wholePosition && rules.wholePosition.forEach(function(e){\n      if (stock.net_value < e.net_value) {\n        // var max_cash = Math.floor(stock.total_assets * e.limit_position / 100);\n        var max_cash = stock.total_assets * e.limit_position / 100;\n        tmpArr.push({\n          max_cash: max_cash,\n          limitAction: e.limit_action\n        });\n      }\n    });\n    // 取出所有符合条件的最大数量之后，取最小的数量及其风控处理即可。\n    var freeNum = Infinity;\n    var limitAction = '';\n    var limit_position = '';\n    var net_value = '';\n    var max_cash = stock.total_assets;\n    tmpArr.forEach(function(e){\n      if (1 == e.limitAction && e.max_cash < max_cash) {\n        max_cash = e.max_cash;\n      }\n    });\n\n    return max_cash;\n  };\n\n  // 整体仓位控制校验函数\n  // rules格式：\n  // {wholePosition:[{rule_id:'',net_value:'',limit_position:'',limit_action:''},{}]}\n  this.doCheck = function(stock, rules){\n    // 仓位限制，将采取这样的逻辑：所有满足净值条件的情况下，取出最大的可交易数量\n    var _this = this;\n    var tmpArr = [];\n    var dstNum = stock.dstNum;\n    rules.wholePosition && rules.wholePosition.forEach(function(e){\n      if (stock.net_value < e.net_value) {\n        // （总资产＊仓位限制－持仓市值）／价格 ？＝ 数量\n        // var freeNum = Math.floor((stock.total_assets * e.limit_position / 100 - stock.security) / stock.price);\n        var balance = (stock.total_assets * e.limit_position / 100 - stock.security);\n        var freeNum = _this.doCheckFee(stock.stock_code, balance, stock.price, rules.feeData);\n        freeNum = Math.max(freeNum, 0);\n        var max_cash = Math.floor(stock.total_assets * e.limit_position / 100);\n        tmpArr.push({\n          net_value: e.net_value,\n          limit_position: e.limit_position,\n          freeNum: freeNum,\n          max_cash: max_cash,\n          limitAction: e.limit_action\n        });\n      }\n    });\n\n    // 旧的计算方式是只传入处理方式为禁止的风控数据，新的要把提示的也传进去\n    var rtnArr = [{\n      limitAction: 0,\n    }, {\n      limitAction: 1,\n    }];\n    // 因为要考虑的就是禁止和提示两种，所以准备一个两个元素的数组就可以啦\n    rtnArr.forEach(obj => {\n      var freeNum = Infinity;\n      var limitAction = obj.limitAction;\n      var limit_position = '';\n      var net_value = '';\n      var max_cash = Infinity;\n\n      tmpArr.forEach(function(e){\n        // 每次for循环准备不同的风控预警操作\n        if (obj.limitAction == e.limitAction && e.freeNum < freeNum) {\n          freeNum = e.freeNum;\n          limitAction = e.limitAction;\n          limit_position = e.limit_position;\n          net_value = e.net_value;\n          max_cash = e.max_cash;\n        }\n      });\n\n      Object.assign(obj, this.compareReturn({\n        dstNum: dstNum,\n        freeNum: freeNum,\n        limitAction: limitAction\n      }));\n\n      if (0 == obj.code) {\n        obj.msg = '净值仓位校验成功';\n      }else if(1 == obj.code){\n        obj.msg = '已触发提示性风控（个股）：单位净值<'+ net_value +'，最大仓位限制' + limit_position + '%';\n      }else{\n        obj.msg = '已触发禁止性风控（个股）：单位净值<'+ net_value +'，最大仓位限制' + limit_position + '%';\n      }\n      obj.ruleType = 'IndependentWholePosition 净值仓位限制风控';\n      obj.max_cash = max_cash;\n    });\n\n    // 3.10.0版本，doCheck不再是返回对象，而是返回数组，包含多个之前格式的对象。因为预警操作有告警和提示两种嘛。\n    return rtnArr;\n  };\n}\nIndependentWholePosition.prototype = new RiskRules();\n\n// 单票(净值)仓位限制\nfunction IndependentOnePosition(){\n  // 校验内容：股票stock_code；资产总值total_assets；价格price；数量dstNum；单股持仓市值market_value；\n  this.checkStockData = function(stock){\n    return (stock.hasOwnProperty('stock_code') &&\n      stock.hasOwnProperty('stock_name') &&\n      stock.hasOwnProperty('total_assets') &&\n      stock.hasOwnProperty('price') &&\n      stock.hasOwnProperty('dstNum') &&\n      stock.hasOwnProperty('market_value'));\n  };\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('customPool') && rules.hasOwnProperty('onePosition') && rules.hasOwnProperty('feeData');\n  };\n  this.doCheck = function(stock, rules){\n    var _this = this;\n    // 过滤内部股票池，得到股票在股票池的规则集合\n    var rulesAll = this.getPositionLimit(stock, rules);\n    // 接下来的处理流程可用和wholePosition的处理类似了，但是不需要考虑净值分级\n    var tmpArr = [];\n    var dstNum = stock.dstNum;\n    rulesAll.forEach(function(e){\n      // （总资产＊仓位限制－持仓市值）／价格 ？＝ 数量\n      // var freeNum = Math.floor((stock.total_assets * e.limitPosition / 100 - stock.market_value) / stock.price);\n      var balance = (stock.total_assets * e.limitPosition / 100 - stock.market_value);\n      var freeNum = _this.doCheckFee(stock.stock_code, balance, stock.price, rules.feeData);\n      var max_cash = (stock.total_assets * e.limitPosition / 100 - stock.market_value);\n      tmpArr.push({\n        limit_position: e.limitPosition,\n        freeNum: freeNum,\n        max_cash: max_cash,\n        limitAction: e.limitAction\n      });\n    });\n\n    // 旧的计算方式是只传入处理方式为禁止的风控数据，新的要把提示的也传进去\n    var rtnArr = [{\n      limitAction: 0,\n    }, {\n      limitAction: 1,\n    }];\n    // 因为要考虑的就是禁止和提示两种，所以准备一个两个元素的数组就可以啦\n    rtnArr.forEach(obj => {\n      var freeNum = Infinity;\n      var max_cash = Infinity;\n      var limitAction = obj.limitAction;\n      var limit_position = '';\n      tmpArr.forEach(function(e){\n        if (obj.limitAction == e.limitAction && e.freeNum < freeNum) {\n          freeNum = e.freeNum;\n          max_cash = e.max_cash;\n          limitAction = e.limitAction;\n          limit_position = e.limit_position;\n        }\n      });\n\n      Object.assign(obj, this.compareReturn({\n        dstNum: dstNum,\n        freeNum: freeNum,\n        limitAction: limitAction\n      }));\n\n      // // 根据tmpArr是否含有比freeNum还要小的freeNum，重新计算code\n      // if (obj.code == 0) {\n      //   tmpArr.forEach(function(e){\n      //     if (e.freeNum < obj.freeNum) {\n      //       obj.code = 1;\n      //     }\n      //   });\n      // }\n\n      if (0 == obj.code) {\n        obj.msg = '单票(净值)仓位校验成功';\n      }else if(1 == obj.code){\n        obj.msg = '已触发提示性风控（个股）：个股最大仓位限制' + limit_position + '%';\n      }else{\n        obj.msg = '已触发禁止性风控（个股）：个股最大仓位限制' + limit_position + '%';\n        // obj.msg = '单票(净值)仓位校验失败';\n      }\n      obj.max_cash = max_cash;\n      obj.ruleType = 'IndependentOnePosition 单票(净值)仓位限制风控';\n    })\n\n    // 3.10.0版本，doCheck不再是返回对象，而是返回数组，包含多个之前格式的对象。因为预警操作有告警和提示两种嘛。\n    return rtnArr;\n  };\n\n  //\n  this.getPositionLimit = function(stock, rules){\n    var _this = this;\n    var rtn = [];\n    rules.onePosition && rules.onePosition.forEach(function(e){\n      if ( !_this.insidePool.hasOwnProperty(Number(e.stock_pool_id))) {\n        // 取出该股票池的数据，判断股票代码是否在默认股票池内\n        rules.customPool.forEach(function(el){\n          if (el.id == e.stock_pool_id) {\n            // 判断股票是否在股票池内\n            if (el.list.some(function(cur, i){\n              return cur.toLowerCase() === stock.stock_code.toLowerCase();\n            })) {\n              rtn.push({\n                stockPoolId: Number(e.stock_pool_id),\n                stockPoolName:  el.pool_name,\n                limitPosition: e.limit_position,\n                limitAction: e.limit_action\n              });\n            }\n          }\n        });\n      }else{\n        if (_this.insidePool[Number(e.stock_pool_id)](stock)) {\n          rtn.push({\n            stockPoolId: Number(e.stock_pool_id),\n            stockPoolName:  _this.insidePoolName[e.stock_pool_id](),\n            limitPosition: e.limit_position,\n            limitAction: e.limit_action\n          });\n        }\n      }\n    });\n\n    return rtn;\n  };\n}\nIndependentOnePosition.prototype = new RiskRules();\n\n// 黑名单\nfunction IndependentTarget(){\n  // 校验内容：股票stock_code\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('stock_code') && stock.hasOwnProperty('dstNum') && stock.hasOwnProperty('stock_name');\n  };\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('customPool') && rules.hasOwnProperty('target');\n  };\n  this.getStatus = function(stock, rules){\n    var rules = this.getPositionLimit(stock,rules);\n    var stockPoolName = '';\n    var _this = this;\n    var rtn = {\n      status: 0,\n      stockPoolName : '',\n      blackListMsg: ''\n    };\n    rules.forEach(function(e){\n      // todo 这里只有内置股票的处理，缺少自定义股票池的展示\n      if (1 == e.limitAction) {\n        rtn.blackListMsg = '已触发禁止性风控（个股）：属于'+ e.stockPoolName + '，禁止买入';\n        rtn.stockPoolName = e.stockPoolName;\n        rtn.status = 1;\n      }\n    });\n    return rtn;\n  };\n  this.doCheck = function(stock, rules){\n    var _this = this;\n    var rules = this.getPositionLimit(stock,rules);\n    var dstNum = stock.dstNum;\n\n    // 旧的计算方式是只传入处理方式为禁止的风控数据，新的要把提示的也传进去\n    var rtnArr = [{\n      limitAction: 0,\n    }, {\n      limitAction: 1,\n    }];\n    // 因为要考虑的就是禁止和提示两种，所以准备一个两个元素的数组就可以啦\n    rtnArr.forEach(obj => {\n      var freeNum = Infinity;\n      var limitAction = obj.limitAction;\n      var stockPoolName = '';\n      var max_cash = Infinity;\n      rules.forEach(function(e){\n        if (obj.limitAction == e.limitAction) {\n          freeNum = 0;\n          max_cash = 0;\n          limitAction = e.limitAction;\n          // todo 这里只有内置股票的处理，缺少自定义股票池的展示\n          stockPoolName = e.stockPoolName;\n        }\n      });\n\n      Object.assign(obj, this.compareReturn({\n        dstNum: dstNum,\n        freeNum: freeNum,\n        limitAction: limitAction\n      }));\n\n      if (0 == obj.code) {\n        obj.msg = '黑名单校验成功';\n      }else if(1 == obj.code){\n        obj.msg = '已触发提示性风控（个股）：属于'+ stockPoolName + '，禁止买入';\n      }else{\n        obj.msg = '已触发禁止性风控（个股）：属于'+ stockPoolName + '，禁止买入';\n      }\n      obj.max_cash = max_cash;\n      obj.ruleType = 'IndependentTarget 黑名单限制风控';\n    });\n\n    // 3.10.0版本，doCheck不再是返回对象，而是返回数组，包含多个之前格式的对象。因为预警操作有告警和提示两种嘛。\n    return rtnArr;\n  };\n  //\n  this.getPositionLimit = function(stock, rules){\n    var _this = this;\n    var rtn = [];\n    rules.target && rules.target.forEach(function(e){\n      if ( !_this.insidePool.hasOwnProperty(Number(e.stock_pool_id))) {\n        // 取出该股票池的数据，判断股票代码是否在默认股票池内\n        rules.customPool.forEach(function(el){\n          if (el.id == e.stock_pool_id) {\n            // 判断股票是否在股票池内\n            if (el.list.some(function(cur, i){\n              return cur.toLowerCase() === stock.stock_code.toLowerCase();\n            })) {\n              rtn.push({\n                stockPoolId: Number(e.stock_pool_id),\n                stockPoolName:  el.pool_name,\n                limitAction: e.limit_action\n              });\n            }\n          }\n        });\n      }else{\n        if (_this.insidePool[Number(e.stock_pool_id)](stock)) {\n          rtn.push({\n            stockPoolId: Number(e.stock_pool_id),\n            stockPoolName:  _this.insidePoolName[e.stock_pool_id](),\n            limitAction: e.limit_action\n          });\n        }\n      }\n    });\n\n    return rtn;\n  };\n}\nIndependentTarget.prototype = new RiskRules();\n\n// 时间段\nfunction IndependentTimeArea(){\n  // 校验内容 小时数time_h\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('time_h') && stock.hasOwnProperty('dstNum');\n  };\n  this.checkRulesData = function(rules){\n    return true;\n  };\n  this.doCheck = function(stock, rules){\n    var rtn;\n    //16-17点，禁止下单\n    if (Number(stock.time_h) == 16) {\n      rtn = this.compareReturn({\n        trading_unit: stock.trading_unit,\n        dstNum: stock.dstNum,\n        freeNum: 0,\n        limitAction: 1 //禁止\n      });\n    }else{\n      rtn = this.compareReturn({\n        trading_unit: stock.trading_unit,\n        dstNum: stock.dstNum,\n        freeNum: Infinity,\n        limitAction: 1 //禁止\n      });\n    }\n\n    if (0 == rtn.code) {\n      rtn.msg = '时间段校验成功';\n      rtn.max_cash = Infinity;\n    }else if(1 == rtn.code){\n      rtn.msg = '异常：时间段校验失败后应该强制禁止';\n      rtn.max_cash = Infinity;\n    }else{\n      rtn.msg = '时间段校验失败';\n      rtn.max_cash = 0;\n    }\n    rtn.ruleType = 'IndependentTimeArea 时间段限制风控';\n    return [rtn];\n  }\n}\nIndependentTimeArea.prototype = new RiskRules();\n\n// 可卖\nfunction IndependentCanSellVolume(){\n  // 校验内容：数量dstNum；可出售数量enable_sell_volume；\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('dstNum') && stock.hasOwnProperty('enable_sell_volume');\n  };\n  this.checkRulesData = function(rules){\n    return true;\n  };\n  this.doCheck = function(stock, rules){\n    var dstNum = stock.dstNum;\n    var freeNum = stock.enable_sell_volume;\n    var rtn = this.compareReturn({\n      trading_unit: stock.trading_unit,\n      frozenFreeNum: true,\n      dstNum: dstNum,\n      freeNum: freeNum,\n      limitAction: 1 //禁止\n    });\n\n    if (0 == rtn.code) {\n      rtn.msg = '可卖数量校验成功';\n    }else if(1 == rtn.code){\n      rtn.msg = '已触发提示性风控（个股）：可卖数量不足';\n    }else{\n      rtn.msg = '已触发禁止性风控（个股）：可卖数量不足'; // '可卖数量校验失败';\n    }\n    rtn.ruleType = 'IndependentCanSellVolume 可卖限制风控';\n    return [rtn];\n  }\n}\nIndependentCanSellVolume.prototype = new RiskRules();\n\n// 新增，独立风控，举牌\nfunction IndependentPlacards(){\n  // 校验内容：该股票已发行股票数量stock_total_share；已持仓该股票数量stock_position_num；已委托该股票数量stock_entrust_num；数量dstNum\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('stock_total_share') && stock.hasOwnProperty('stock_position_num') && stock.hasOwnProperty('stock_entrust_num') && stock.hasOwnProperty('dstNum')\n  };\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('placards');\n  };\n  this.doCheck = function(stock, rules){\n    var dstNum = stock.dstNum;\n    var arr = this.checkMaxPlacardsNum(stock, rules);\n    // 屏蔽港股校验\n    if (/\\.hk/.test(stock.stock_code.toLowerCase())) {\n      arr = [];\n    }\n    var max_cash;\n\n    // 旧的计算方式是只传入处理方式为禁止的风控数据，新的要把提示的也传进去\n    var rtnArr = [{\n      limitAction: 0,\n    }, {\n      limitAction: 1,\n    }];\n    rtnArr.forEach(obj => {\n      var freeNum = Infinity;\n      var limitAction = obj.limitAction;\n      var limitPosition = '';\n\n      arr.forEach(function(e){\n        if (obj.limitAction == e.limit_action) {\n          freeNum = e.freeNum;\n          max_cash = Infinity;\n          limitAction = e.limit_action;\n          limitPosition = e.limitPosition; // 记住触发的比例\n        }\n      });\n\n      Object.assign(obj, this.compareReturn({\n        dstNum: dstNum,\n        freeNum: freeNum,\n        limitAction: limitAction\n      }));\n\n      if (0 == obj.code) {\n        obj.msg = '举牌校验成功';\n      }else if(1 == obj.code){\n        obj.msg = '已触发提示性风控（个股）：超过'+ limitPosition + '%，触发举牌风控';\n      }else{\n        obj.msg = '已触发禁止性风控（个股）：超过'+ limitPosition + '%，触发举牌风控，禁止买入';\n      }\n      obj.max_cash = max_cash;\n      obj.ruleType = 'IndependentPlacards 举牌风控';\n    })\n\n    return rtnArr;\n  }\n  this.checkMaxPlacardsNum = function(stock, rules){\n    var _this = this;\n    var rtn = [];\n    rules.placards && rules.placards.forEach(function(e){\n      // 计算最大可买数量\n      var freeNum = Math.max(stock.stock_total_share * e.limit_position / 100 - stock.stock_position_num - stock.stock_entrust_num - 100, 0);\n      rtn.push({\n        // limit_position\n        limitPosition: e.limit_position, // 记住触发的比例\n        freeNum: freeNum,\n        limit_action: e.limit_action\n      })\n    });\n\n    return rtn;\n  }\n}\nIndependentPlacards.prototype = new RiskRules();\n\n// 新增，独立风控，对敲\nfunction IndependentControTrade(){\n  // 校验内容：该产品已委托买入数量stock_entrust_buy_num；该产品已委托卖出数量stock_entrust_sell_num；数量dstNum\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('trade_direction') && stock.hasOwnProperty('stock_entrust_buy_num') && stock.hasOwnProperty('stock_entrust_sell_num') && stock.hasOwnProperty('dstNum');\n  };\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('controTrade');\n  };\n  this.doCheck = function(stock, rules){\n    var dstNum = stock.dstNum;\n    var arr = this.checkControTradeNum(stock, rules);\n    var max_cash;\n\n    // 旧的计算方式是只传入处理方式为禁止的风控数据，新的要把提示的也传进去\n    var rtnArr = [{\n      limitAction: 0,\n    }, {\n      limitAction: 1,\n    }];\n    rtnArr.forEach(obj => {\n      var freeNum = Infinity;\n      var limitAction = obj.limitAction;\n      arr.forEach(function(e){\n        if (obj.limitAction == e.limitAction) {\n          freeNum = e.freeNum;\n          max_cash = e.max_cash;\n          limitAction = e.limitAction;\n        }\n      });\n\n      Object.assign(obj, this.compareReturn({\n        dstNum: dstNum,\n        freeNum: freeNum,\n        limitAction: limitAction\n      }));\n\n      if (0 == obj.code) {\n        obj.msg = '对敲校验成功';\n      }else if(1 == obj.code){\n        obj.msg = '已触发提示性风控（个股）：触发对敲风控';\n      }else{\n        obj.msg = '已触发禁止性风控（个股）：触发对敲风控，提交委托禁止与未成交委托反向';\n      }\n      obj.max_cash = max_cash;\n      obj.ruleType = 'IndependentControTrade 对敲风控';\n    })\n\n    return rtnArr;\n  };\n\n  this.checkControTradeNum = function(stock, rules){\n    var _this = this;\n    var rtn = [];\n    rules.controTrade && rules.controTrade.forEach(function(e){\n      // 买入\n      if (1 == stock.trade_direction && stock.stock_entrust_sell_num > 0) {\n        rtn.push({\n          freeNum: 0,\n          max_cash: Infinity,\n          limitAction: e.limit_action\n        })\n      }else if(2 == stock.trade_direction && stock.stock_entrust_buy_num > 0){\n        rtn.push({\n          freeNum: 0,\n          max_cash: Infinity,\n          limitAction: e.limit_action\n        })\n      }else{\n        rtn.push({\n          freeNum: Infinity,\n          max_cash: Infinity,\n          limitAction: e.limit_action\n        })\n      }\n    });\n\n    return rtn;\n  };\n}\nIndependentControTrade.prototype = new RiskRules();\n\n// 新增，联合风控，举牌\nfunction UnionPlacards(){\n  // 校验内容：所有的持仓汇总该股票数量stock_all_position_num；所有的委托汇总该股票数量stock_all_entrust_num；数量dstNum\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('stock_all_position_num') && stock.hasOwnProperty('stock_all_entrust_num') && stock.hasOwnProperty('dstNum')\n  };\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('placardsCo');\n  };\n  this.doCheck = function(stock, rules){\n    var dstNum = stock.dstNum;\n    var arr = this.checkMaxPlacardsNum(stock, rules);\n    // 屏蔽港股校验\n    if (/\\.hk/.test(stock.stock_code.toLowerCase())) {\n      arr = [];\n    }\n    var max_cash;\n\n    // 旧的计算方式是只传入处理方式为禁止的风控数据，新的要把提示的也传进去\n    var rtnArr = [{\n      limitAction: 0,\n    }, {\n      limitAction: 1,\n    }];\n    rtnArr.forEach(obj => {\n      var freeNum = Infinity;\n      var limitAction = obj.limitAction;\n      var limitPosition = '';\n      arr.forEach(function(e){\n        if (obj.limitAction == e.limit_action) {\n          freeNum = e.freeNum;\n          max_cash = Infinity;\n          limitAction = e.limit_action;\n          limitPosition = e.limitPosition; // 记住触发的比例\n        }\n      });\n\n      Object.assign(obj, this.compareReturn({\n        dstNum: dstNum,\n        freeNum: freeNum,\n        limitAction: limitAction\n      }));\n\n      if (0 == obj.code) {\n        obj.msg = '举牌校验成功';\n      }else if(1 == obj.code){\n        obj.msg = '已触发提示性风控（联合）：超过'+ limitPosition + '%，触发举牌风控';\n      }else{\n        obj.msg = '已触发禁止性风控（联合）：超过'+ limitPosition + '%，触发举牌风控，禁止买入';\n      }\n      obj.max_cash = max_cash;\n      obj.ruleType = 'UnionPlacards 举牌联合风控';\n    });\n\n    return rtnArr;\n  };\n  this.checkMaxPlacardsNum = function(stock, rules){\n    var _this = this;\n    var rtn = [];\n    rules.placardsCo && rules.placardsCo.forEach(function(e){\n      // 计算最大可买数量 //因为举牌要考虑等号，所以额外减去100了。\n      var freeNum = Math.max(stock.stock_total_share * e.limit_position / 100 - stock.stock_all_position_num - stock.stock_all_entrust_num - 100, 0);\n      rtn.push({\n        // limit_position\n        limitPosition: e.limit_position, // 记住触发的比例\n        freeNum: freeNum,\n        limit_action: e.limit_action\n      })\n    });\n\n    return rtn;\n  }\n}\nUnionPlacards.prototype = new RiskRules();\n\n// 新增，联合风控，对敲\nfunction UnionControTrade(){\n  // 校验内容：所有的产品已委托买入数量stock_all_entrust_buy_num；所有的产品已委托卖出数量stock_all_entrust_sell_num；数量dstNum\n  this.checkStockData = function(stock){\n    return stock.hasOwnProperty('trade_direction') && stock.hasOwnProperty('stock_all_entrust_buy_num') && stock.hasOwnProperty('stock_all_entrust_sell_num') && stock.hasOwnProperty('dstNum')\n  };\n  this.checkRulesData = function(rules){\n    return rules.hasOwnProperty('controTradeCo');\n  };\n\n  this.doCheck = function(stock, rules){\n    var dstNum = stock.dstNum;\n    var arr = this.checkControTradeNum(stock, rules);\n    var max_cash;\n\n    // 旧的计算方式是只传入处理方式为禁止的风控数据，新的要把提示的也传进去\n    var rtnArr = [{\n      limitAction: 0,\n    }, {\n      limitAction: 1,\n    }];\n    rtnArr.forEach(obj => {\n      var freeNum = Infinity;\n      var limitAction = obj.limitAction;\n      arr.forEach(function(e){\n        if (obj.limitAction == e.limitAction) {\n          freeNum = e.freeNum;\n          max_cash = e.max_cash;\n          limitAction = e.limitAction;\n        }\n      });\n\n      Object.assign(obj, this.compareReturn({\n        dstNum: dstNum,\n        freeNum: freeNum,\n        limitAction: limitAction\n      }));\n\n      if (0 == obj.code) {\n        obj.msg = '对敲风控校验成功';\n      }else if(1 == obj.code){\n        obj.msg = '已触发提示性风控（联合）：触发对敲风控';\n      }else{\n        obj.msg = '已触发禁止性风控（联合）：触发对敲风控，提交委托禁止与未成交委托反向';\n      }\n      obj.max_cash = max_cash;\n      obj.ruleType = 'UnionControTrade 对敲联合风控';\n    });\n\n    return rtnArr;\n  };\n\n  this.checkControTradeNum = function(stock, rules){\n    var _this = this;\n    var rtn = [];\n    rules.controTradeCo && rules.controTradeCo.forEach(function(e){\n      // 买入\n      if (1 == stock.trade_direction && stock.stock_all_entrust_sell_num > 0) {\n        rtn.push({\n          freeNum: 0,\n          max_cash: Infinity,\n          limitAction: e.limit_action\n        })\n      }else if(2 == stock.trade_direction && stock.stock_all_entrust_buy_num > 0){\n        rtn.push({\n          freeNum: 0,\n          max_cash: Infinity,\n          limitAction: e.limit_action\n        })\n      }else{\n        rtn.push({\n          freeNum: Infinity,\n          max_cash: Infinity,\n          limitAction: e.limit_action\n        })\n      }\n    });\n\n    return rtn;\n  };\n}\nUnionControTrade.prototype = new RiskRules();\n\n// 可用资金为例\n// 计算式：股票价格＊数量 ?= 可用资金\n// var balanceCheck = new Balance();\n// var stockData = {\n//   balance: '可用资金',\n//   price: '股票价格',\n//   dstNum: '想要交易数量'\n// };\n// var rulesData = {\n//   // 可用资金不需要风控规则\n// };\n// // 使用方法\n// var obj = balanceCheck.check(stockData, rulesData);\n\n// 净值仓位限制\n// 计算式：总资产＊仓位限制 ?= 持仓市值＋价格＊数量\n// var wholePositionCheck = new WholePosition();\n// var stockData = {\n//   '总资产': '总资产',\n//   '持仓市值': '持仓市值',\n//   price: '股票价格',\n//   dstNum: '想要交易数量'\n// };\n// var rulesData = {\n//   wholePosition:[[净值，仓位], [净值，仓位]]\n// };\n// var obj = wholePositionCheck.check(stockData, rulesData);\n\n// 单票持仓限制\n// 计算式：总资产＊个股仓位限制 ?= 单票持仓＋价格＊数量\n// var onePositionCheck = new OnePosition();\n// var stockData = {\n//   '总资产': '',\n//   '单票持仓市值': '',\n//   price: '股票价格',\n//   dstNum: '想要交易数量',\n//   stockCode: '股票id'\n// };\n// var rulesData = {\n//   // 不需要风控规则\n//   // 系统内置股票池内部计算即可\n//   // 自定义股票池，后续要支持的话，提前一次性获取股票池。（通过调用实例onePositionCheck的(其它新增的)方法传入自定义股票池）\n\n//   // 还是要风控规则的\n//   // 比如说规则时股票池11不允许超过12，这条消息还是要传过来的。这里再根据股票池枚举值11知道是那个系统内置股票池，再判断股票在不在股票池内\n//   // 然后才能谈及仓位限制。\n// };\n// var obj = onePositionCheck.check(stockData, rulesData);\n\n// 黑名单\n// 计算式：判断是否属于黑名单\n// var targetCheck = new Target();\n// var stockData = {\n//   stockCode: '股票id'\n// };\n// var rulesData = {\n//   // 不需要风控规则\n\n// };\n// var obj = targetCheck.check(stockData, rulesData);\n\n// 时间段\n// 计算式：判断是否属于该时间段\n// var timeAreaCheck = new TimeArea();\n// var stockData = {\n//   dstNum: '想要交易数量'\n// };\n// var rulesData = {\n//   timeArea: [{\n//     time: '时间段',\n//     action: '处理方式'\n//   }];\n// };\n// var obj = timeAreaCheck.check(stockData, rulesData);\n\n// 可卖\n// var canSellVolumeCheck = new CanSellVolume();\n// var stockData = {\n//   dstNum: '想要交易数量',\n//   '当前持仓数量': '',\n//   '当日买入数量': ''\n// };\n// var rulesData = {\n//   // 不需要风控规则\n// }\n// var obj = canSellVolumeCheck.check(stockData, rulesData);\n\n// 多仓位判断，风控处理可能不同的净值不同的风控处理结果，需要\n// 要么这里单条单条的处理\n// 要么，风控处理的结果要和单条的数据一起传过来（应该选用这种，因为如果只是告警提醒，可交易数量应该还是dstNum）\n\n// 费用计算，额外暴露给外面使用\nvar riskRules = new RiskRules();\n\n// 3.10.0版本，新增了新的风控规则，并且支持告警提醒。采取这样的方式，所有的风控全部重写！\n// 前缀independent表示独立风控，前缀\nvar independentBalanceCheck = new IndependentBalance(); // 可用资金风控\nvar independentWholePositionCheck = new IndependentWholePosition(); // 净值仓位风控\nvar independentOnePositionCheck = new IndependentOnePosition(); // 单票持仓风控\nvar independentTargetCheck = new IndependentTarget(); // 黑名单\nvar independentTimeAreaCheck = new IndependentTimeArea(); // 时间段\nvar independentCanSellVolumeCheck = new IndependentCanSellVolume(); // 独立风控\nvar independentPlacardsCheck = new IndependentPlacards(); // 举牌\nvar independentControTradeCheck = new IndependentControTrade(); // 对敲\n\n// var unionOnePositionCheck = new UnionOnePosition(); // 联合风控，单票持仓 不需要，因为 前端基于有限的数据可能比后端基于全部数据的风控还要严格\nvar unionPlacardsCheck = new UnionPlacards(); // 联合风控，举牌\nvar unionControTradeCheck = new UnionControTrade(); // 联合风控，对敲"]}